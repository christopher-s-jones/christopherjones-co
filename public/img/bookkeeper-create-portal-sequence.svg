<svg xmlns="http://www.w3.org/2000/svg" width="1280" height="1045" data-diagram-type="SEQUENCE" preserveAspectRatio="none" style="width:1280px;height:1045px;background:#fff"><text x="533.931" y="28.535" font-family="sans-serif" font-size="14" font-weight="bold" textLength="210.191">Uploading a portal document</text><path fill="#428BCA" d="M40.218 259.529h10v55.276h-10zM311.224 150.287h10v29.311h-10zM311.224 219.564h10v39.966h-10zM311.224 314.806h10v107.208h-10zM311.224 730.051h10v29.311h-10zM581.493 422.014h10v78.242h-10zM581.493 658.43h10v194.484h-10zM928.638 179.598h10v39.966h-10zM928.638 500.256h10v62.932h-10zM928.638 610.809h10v47.621h-10zM928.638 852.914h10v93.553h-10zM1231.052 563.188h10v47.621h-10z" style="stroke:#1f4260;stroke-width:1"/><path fill="none" d="M41.218 118.977h8v845.49h-8z"/><path d="M45 118.977v845.49" style="stroke:#1f4260;stroke-width:.5;stroke-dasharray:5,5"/><path fill="none" d="M312.224 118.977h8v845.49h-8z"/><path d="M315.471 118.977v845.49" style="stroke:#1f4260;stroke-width:.5;stroke-dasharray:5,5"/><path fill="none" d="M582.493 118.977h8v845.49h-8z"/><path d="M586.43 118.977v845.49" style="stroke:#1f4260;stroke-width:.5;stroke-dasharray:5,5"/><path fill="none" d="M929.638 118.977h8v845.49h-8z"/><path d="M932.86 118.977v845.49" style="stroke:#1f4260;stroke-width:.5;stroke-dasharray:5,5"/><path fill="none" d="M1232.052 118.977h8v845.49h-8z"/><path d="M1236.051 118.977v845.49" style="stroke:#1f4260;stroke-width:.5;stroke-dasharray:5,5"/><g class="participant participant-head" data-participant="Researcher"><text x="5" y="116.023" font-family="sans-serif" font-size="14" textLength="74.436">Researcher</text><circle cx="45.218" cy="50.988" r="8" fill="#DDD" style="stroke:#333;stroke-width:.5"/><path fill="none" d="M45.218 58.988v27m-13-19h26m-13 19-13 15m13-15 13 15" style="stroke:#333;stroke-width:.5"/></g><g class="participant participant-tail" data-participant="Researcher"><text x="5" y="977.002" font-family="sans-serif" font-size="14" textLength="74.436">Researcher</text><circle cx="45.218" cy="988.455" r="8" fill="#DDD" style="stroke:#333;stroke-width:.5"/><path fill="none" d="M45.218 996.455v27m-13-19h26m-13 19-13 15m13-15 13 15" style="stroke:#333;stroke-width:.5"/></g><g class="participant participant-head" data-participant="Client"><rect width="53.505" height="30.488" x="289.471" y="87.488" fill="#F5F5F5" rx="2.5" ry="2.5" style="stroke:#aaa;stroke-width:.5"/><text x="296.471" y="108.023" font-family="sans-serif" font-size="14" textLength="39.505">Client</text></g><g class="participant participant-tail" data-participant="Client"><rect width="53.505" height="30.488" x="289.471" y="963.467" fill="#F5F5F5" rx="2.5" ry="2.5" style="stroke:#aaa;stroke-width:.5"/><text x="296.471" y="984.002" font-family="sans-serif" font-size="14" textLength="39.505">Client</text></g><g class="participant participant-head" data-participant="Repository"><rect width="86.126" height="46.977" x="543.43" y="71" fill="#F5F5F5" rx="2.5" ry="2.5" style="stroke:#aaa;stroke-width:.5"/><text x="555.492" y="91.535" font-family="sans-serif" font-size="14" font-style="italic" textLength="62.002">«Service»</text><text x="550.43" y="108.023" font-family="sans-serif" font-size="14" textLength="72.126">Repository</text></g><g class="participant participant-tail" data-participant="Repository"><rect width="86.126" height="46.977" x="543.43" y="963.467" fill="#F5F5F5" rx="2.5" ry="2.5" style="stroke:#aaa;stroke-width:.5"/><text x="555.492" y="984.002" font-family="sans-serif" font-size="14" font-style="italic" textLength="62.002">«Service»</text><text x="550.43" y="1000.49" font-family="sans-serif" font-size="14" textLength="72.126">Repository</text></g><g class="participant participant-head" data-participant="Bookkeeper"><rect width="93.557" height="46.977" x="886.86" y="71" fill="#F5F5F5" rx="2.5" ry="2.5" style="stroke:#aaa;stroke-width:.5"/><text x="902.637" y="91.535" font-family="sans-serif" font-size="14" font-style="italic" textLength="62.002">«Service»</text><text x="893.86" y="108.023" font-family="sans-serif" font-size="14" textLength="79.557">Bookkeeper</text></g><g class="participant participant-tail" data-participant="Bookkeeper"><rect width="93.557" height="46.977" x="886.86" y="963.467" fill="#F5F5F5" rx="2.5" ry="2.5" style="stroke:#aaa;stroke-width:.5"/><text x="902.637" y="984.002" font-family="sans-serif" font-size="14" font-style="italic" textLength="62.002">«Service»</text><text x="893.86" y="1000.49" font-family="sans-serif" font-size="14" textLength="79.557">Bookkeeper</text></g><g class="participant participant-head" data-participant="CN"><rect width="76.002" height="46.977" x="1198.051" y="71" fill="#F5F5F5" rx="2.5" ry="2.5" style="stroke:#aaa;stroke-width:.5"/><text x="1205.051" y="91.535" font-family="sans-serif" font-size="14" font-style="italic" textLength="62.002">«Service»</text><text x="1226.037" y="108.023" font-family="sans-serif" font-size="14" textLength="20.029">CN</text></g><g class="participant participant-tail" data-participant="CN"><rect width="76.002" height="46.977" x="1198.051" y="963.467" fill="#F5F5F5" rx="2.5" ry="2.5" style="stroke:#aaa;stroke-width:.5"/><text x="1205.051" y="984.002" font-family="sans-serif" font-size="14" font-style="italic" textLength="62.002">«Service»</text><text x="1226.037" y="1000.49" font-family="sans-serif" font-size="14" textLength="20.029">CN</text></g><path fill="#428BCA" d="M40.218 259.529h10v55.276h-10zM311.224 150.287h10v29.311h-10zM311.224 219.564h10v39.966h-10zM311.224 314.806h10v107.208h-10zM311.224 730.051h10v29.311h-10zM581.493 422.014h10v78.242h-10zM581.493 658.43h10v194.484h-10zM928.638 179.598h10v39.966h-10zM928.638 500.256h10v62.932h-10zM928.638 610.809h10v47.621h-10zM928.638 852.914h10v93.553h-10zM1231.052 563.188h10v47.621h-10z" style="stroke:#1f4260;stroke-width:1"/><g class="message" data-participant-1="Researcher" data-participant-2="Client"><circle cx="44.718" cy="149.537" r="4" style="stroke:#333;stroke-width:1.5"/><path fill="#333" d="m299.224 146.287 10 4-10 4 4-4z" style="stroke:#333;stroke-width:1"/><path d="M49.218 150.287h256.006" style="stroke:#333;stroke-width:1"/><text x="52.218" y="145.545" fill="#999" font-family="sans-serif" font-size="13" textLength="8.22">1</text><text x="64.439" y="145.545" font-family="sans-serif" font-size="13" textLength="204.636">Chooses &quot;Edit&quot; for a listed portal</text></g><g class="message" data-participant-1="Client" data-participant-2="Bookkeeper"><path fill="#333" d="m916.638 175.598 10 4-10 4 4-4z" style="stroke:#333;stroke-width:1"/><path d="M316.224 179.598h606.414" style="stroke:#333;stroke-width:1"/><text x="323.224" y="174.856" fill="#999" font-family="sans-serif" font-size="13" textLength="8.22">2</text><text x="335.444" y="174.856" font-family="sans-serif" font-size="13" textLength="221.222">getUsage(session, sid, quotaName)</text></g><g class="message" data-participant-1="Bookkeeper" data-participant-2="Client"><path fill="#333" d="m332.224 215.564-10 4 10 4-4-4z" style="stroke:#333;stroke-width:1"/><path d="M326.224 219.564h606.414" style="stroke:#333;stroke-width:1;stroke-dasharray:2,2"/><text x="338.224" y="214.821" fill="#999" font-family="sans-serif" font-size="13" textLength="8.22">3</text><text x="350.444" y="214.821" font-family="sans-serif" font-size="13" textLength="37.223">usage</text></g><path fill="#FCF8E4" d="M943 195.098v35a2.5 2.5 0 0 0 2.5 2.5h252a2.5 2.5 0 0 0 2.5-2.5v-27.5l-10-10H945.5a2.5 2.5 0 0 0-2.5 2.5" style="stroke:#fceed6;stroke-width:.5"/><path fill="#FCF8E4" d="M1190 192.598v8.75a1.25 1.25 0 0 0 1.25 1.25h8.75l-10-10" style="stroke:#fceed6;stroke-width:.5"/><text x="949" y="210.166" fill="#C49858" font-family="sans-serif" font-size="13" textLength="236.666">Checks usages of the given pid or sid</text><text x="949" y="225.477" fill="#C49858" font-family="sans-serif" font-size="13" textLength="210.628">for the given quota name &quot;portal&quot;</text><g class="message" data-participant-1="Client" data-participant-2="Researcher"><path fill="#333" d="m61.218 255.53-10 4 10 4-4-4z" style="stroke:#333;stroke-width:1"/><path d="M55.218 259.529h260.006" style="stroke:#333;stroke-width:1;stroke-dasharray:2,2"/><text x="67.218" y="254.787" fill="#999" font-family="sans-serif" font-size="13" textLength="8.22">4</text><text x="79.439" y="254.787" font-family="sans-serif" font-size="13" textLength="69.209">editor view</text></g><g class="message" data-participant-1="Researcher" data-participant-2="Client"><path fill="#333" d="m299.224 310.806 10 4-10 4 4-4z" style="stroke:#333;stroke-width:1"/><path d="M45.218 314.806h260.006" style="stroke:#333;stroke-width:1"/><text x="52.218" y="310.063" fill="#999" font-family="sans-serif" font-size="13" textLength="8.22">5</text><text x="64.439" y="310.063" font-family="sans-serif" font-size="13" textLength="229.785">Chooses &quot;Save&quot; after editing a portal</text></g><path fill="#FCF8E4" d="M326 275.03v66a2.5 2.5 0 0 0 2.5 2.5h247a2.5 2.5 0 0 0 2.5-2.5v-58.5l-10-10H328.5a2.5 2.5 0 0 0-2.5 2.5" style="stroke:#fceed6;stroke-width:.5"/><path fill="#FCF8E4" d="M568 272.53v8.75a1.25 1.25 0 0 0 1.25 1.25H578l-10-10" style="stroke:#fceed6;stroke-width:.5"/><text x="332" y="290.098" fill="#C49858" font-family="sans-serif" font-size="13" textLength="216.322">Note that the Client can optionally</text><text x="332" y="305.408" fill="#C49858" font-family="sans-serif" font-size="13" textLength="226.884">call Bookkeeper&apos;s hasRemaining() to</text><text x="332" y="320.719" fill="#C49858" font-family="sans-serif" font-size="13" textLength="200.688">proactively check quotas before</text><text x="332" y="336.029" fill="#C49858" font-family="sans-serif" font-size="13" textLength="231.385">allowing a new portal editor session.</text><g class="message" data-participant-1="Client" data-participant-2="Repository"><path fill="#333" d="m569.493 418.014 10 4-10 4 4-4z" style="stroke:#333;stroke-width:1"/><path d="M316.224 422.014h259.269" style="stroke:#333;stroke-width:1"/><text x="323.224" y="417.272" fill="#999" font-family="sans-serif" font-size="13" textLength="8.22">6</text><text x="335.444" y="417.272" font-family="sans-serif" font-size="13" textLength="229.049">create(session, pid, object, sysmeta)</text></g><path fill="#FCF8E4" d="M114 356.272v66a2.5 2.5 0 0 0 2.5 2.5h186a2.5 2.5 0 0 0 2.5-2.5v-58.5l-10-10H116.5a2.5 2.5 0 0 0-2.5 2.5" style="stroke:#fceed6;stroke-width:.5"/><path fill="#FCF8E4" d="M295 353.772v8.75a1.25 1.25 0 0 0 1.25 1.25H305l-10-10" style="stroke:#fceed6;stroke-width:.5"/><text x="120" y="371.34" fill="#C49858" font-family="sans-serif" font-size="13" textLength="127.074">For all calls, the JWT</text><text x="120" y="386.65" fill="#C49858" font-family="sans-serif" font-size="13" textLength="170.714">authentication token in the</text><text x="120" y="401.961" fill="#C49858" font-family="sans-serif" font-size="13" textLength="170.974">Authorization HTTP header</text><text x="120" y="417.272" fill="#C49858" font-family="sans-serif" font-size="13" textLength="142.067">represents the session</text><path fill="#FCF8E4" d="M591 371.582v35a2.5 2.5 0 0 0 2.5 2.5h303a2.5 2.5 0 0 0 2.5-2.5v-27.5l-10-10H593.5a2.5 2.5 0 0 0-2.5 2.5" style="stroke:#fceed6;stroke-width:.5"/><path fill="#FCF8E4" d="M889 369.082v8.75a1.25 1.25 0 0 0 1.25 1.25H899l-10-10" style="stroke:#fceed6;stroke-width:.5"/><text x="597" y="386.65" fill="#C49858" font-family="sans-serif" font-size="13" textLength="219.572">The Client sends the quota subject</text><text x="597" y="401.961" fill="#C49858" font-family="sans-serif" font-size="13" textLength="287.917">in the X-DataONE-QuotaSubject HTTP header</text><g class="message" data-participant-1="Repository" data-participant-2="Bookkeeper"><path fill="#333" d="m916.638 496.256 10 4-10 4 4-4z" style="stroke:#333;stroke-width:1"/><path d="M586.493 500.256h336.145" style="stroke:#333;stroke-width:1"/><text x="593.493" y="487.858" fill="#999" font-family="sans-serif" font-size="13" textLength="8.22">7</text><text x="605.713" y="480.203" font-family="sans-serif" font-size="13" textLength="239.015">&quot;hasRemaining(session, quotaSubject,</text><text x="605.713" y="495.514" font-family="sans-serif" font-size="13" textLength="305.925">requestorSubject, quotaName, requestedUsage)&quot;</text></g><path fill="#FCF8E4" d="M943 437.514v96a2.5 2.5 0 0 0 2.5 2.5h236a2.5 2.5 0 0 0 2.5-2.5v-88.5l-10-10H945.5a2.5 2.5 0 0 0-2.5 2.5" style="stroke:#fceed6;stroke-width:.5"/><path fill="#FCF8E4" d="M1174 435.014v8.75a1.25 1.25 0 0 0 1.25 1.25h8.75l-10-10" style="stroke:#fceed6;stroke-width:.5"/><text x="949" y="452.582" fill="#C49858" font-family="sans-serif" font-size="13" textLength="194.708">Bookkeeper caches subjectInfo</text><text x="949" y="467.893" fill="#C49858" font-family="sans-serif" font-size="13" textLength="204.909">about the requestor to minimize</text><text x="949" y="483.203" fill="#C49858" font-family="sans-serif" font-size="13" textLength="195.216">calls to the CN. Also, for portal</text><text x="949" y="498.514" fill="#C49858" font-family="sans-serif" font-size="13" textLength="200.389">documents, call hasRemaining()</text><text x="949" y="513.824" fill="#C49858" font-family="sans-serif" font-size="13" textLength="220.549">twice, once to check portal quotas,</text><text x="949" y="529.135" fill="#C49858" font-family="sans-serif" font-size="13" textLength="189.82">once to check storage quotas.</text><g class="message" data-participant-1="Bookkeeper" data-participant-2="CN"><path fill="#333" d="m1219.052 559.188 10 4-10 4 4-4z" style="stroke:#333;stroke-width:1"/><path d="M933.638 563.188h291.414" style="stroke:#333;stroke-width:1"/><text x="940.638" y="558.445" fill="#999" font-family="sans-serif" font-size="13" textLength="8.22">8</text><text x="952.858" y="558.445" font-family="sans-serif" font-size="13" textLength="261.193">getSubjectInfo(session, requestorSubject)</text></g><g class="message" data-participant-1="CN" data-participant-2="Bookkeeper"><path fill="#333" d="m949.638 606.809-10 4 10 4-4-4z" style="stroke:#333;stroke-width:1"/><path d="M943.638 610.809h291.414" style="stroke:#333;stroke-width:1;stroke-dasharray:2,2"/><text x="955.638" y="606.066" fill="#999" font-family="sans-serif" font-size="13" textLength="8.22">9</text><text x="967.858" y="606.066" font-family="sans-serif" font-size="13" textLength="70.173">subjectInfo</text></g><path fill="#FCF8E4" d="M689 578.688v50a2.5 2.5 0 0 0 2.5 2.5h229a2.5 2.5 0 0 0 2.5-2.5v-42.5l-10-10H691.5a2.5 2.5 0 0 0-2.5 2.5" style="stroke:#fceed6;stroke-width:.5"/><path fill="#FCF8E4" d="M913 576.188v8.75a1.25 1.25 0 0 0 1.25 1.25H923l-10-10" style="stroke:#fceed6;stroke-width:.5"/><text x="695" y="593.756" fill="#C49858" font-family="sans-serif" font-size="13" textLength="171.514">If the insert doesn&apos;t exceed</text><text x="695" y="609.066" fill="#C49858" font-family="sans-serif" font-size="13" textLength="176.236">the quota limit, the quota is</text><text x="695" y="624.377" fill="#C49858" font-family="sans-serif" font-size="13" textLength="213.211">returned, otherwise an exception.</text><g class="message" data-participant-1="Bookkeeper" data-participant-2="Repository"><path fill="#333" d="m602.493 654.43-10 4 10 4-4-4z" style="stroke:#333;stroke-width:1"/><path d="M596.493 658.43h336.145" style="stroke:#333;stroke-width:1;stroke-dasharray:2,2"/><text x="608.493" y="653.688" fill="#999" font-family="sans-serif" font-size="13" textLength="16.44">10</text><text x="628.933" y="653.688" font-family="sans-serif" font-size="13" textLength="36.277">quota</text></g><g class="message" data-participant-1="Repository" data-participant-2="Repository"><path d="M591.493 687.74h42m0 0v13m-41 0h41" style="stroke:#333;stroke-width:1"/><path fill="#333" d="m602.493 696.74-10 4 10 4-4-4z" style="stroke:#333;stroke-width:1"/><text x="598.493" y="682.998" fill="#999" font-family="sans-serif" font-size="13" textLength="16.44">11</text><text x="618.933" y="682.998" font-family="sans-serif" font-size="13" textLength="229.049">create(session, pid, object, sysmeta)</text></g><g class="message" data-participant-1="Repository" data-participant-2="Client"><path fill="#333" d="m332.224 726.05-10 4 10 4-4-4z" style="stroke:#333;stroke-width:1"/><path d="M326.224 730.051h254.269" style="stroke:#333;stroke-width:1;stroke-dasharray:2,2"/><text x="338.224" y="725.309" fill="#999" font-family="sans-serif" font-size="13" textLength="16.44">12</text><text x="358.664" y="725.309" font-family="sans-serif" font-size="13" textLength="20.122">pid</text></g><g class="message" data-participant-1="Client" data-participant-2="Researcher"><path fill="#333" d="m56.218 755.361-10 4 10 4-4-4z" style="stroke:#333;stroke-width:1"/><path d="M50.218 759.361h265.006" style="stroke:#333;stroke-width:1;stroke-dasharray:2,2"/><text x="62.218" y="754.619" fill="#999" font-family="sans-serif" font-size="13" textLength="16.44">13</text><text x="82.659" y="754.619" font-family="sans-serif" font-size="13" textLength="152.293">Indicates portal is saved</text></g><g class="message" data-participant-1="Repository" data-participant-2="Bookkeeper"><path fill="#333" d="m916.638 848.914 10 4-10 4 4-4z" style="stroke:#333;stroke-width:1"/><path d="M586.493 852.914h336.145" style="stroke:#333;stroke-width:1;stroke-dasharray:2,2"/><text x="593.493" y="848.172" fill="#999" font-family="sans-serif" font-size="13" textLength="16.44">14</text><text x="613.933" y="848.172" font-family="sans-serif" font-size="13" textLength="239.148">updateUsage(session, quotaId, usage)</text></g><path fill="#FCF8E4" d="M943 774.861v142a2.5 2.5 0 0 0 2.5 2.5h282a2.5 2.5 0 0 0 2.5-2.5v-134.5l-10-10H945.5a2.5 2.5 0 0 0-2.5 2.5" style="stroke:#fceed6;stroke-width:.5"/><path fill="#FCF8E4" d="M1220 772.361v8.75a1.25 1.25 0 0 0 1.25 1.25h8.75l-10-10" style="stroke:#fceed6;stroke-width:.5"/><text x="949" y="789.93" fill="#C49858" font-family="sans-serif" font-size="13" textLength="193.826">The repository asynchronously</text><text x="949" y="805.24" fill="#C49858" font-family="sans-serif" font-size="13" textLength="243.604">updates the usage for the portal count</text><text x="949" y="820.551" fill="#C49858" font-family="sans-serif" font-size="13" textLength="232.864">by sending the usage object with the</text><text x="949" y="835.861" fill="#C49858" font-family="sans-serif" font-size="13" textLength="214.272">instanceId (portal id) and quotaId.</text><text x="949" y="851.172" fill="#C49858" font-family="sans-serif" font-size="13" textLength="250.072">Note the quotaId comes from the quota</text><text x="949" y="866.482" fill="#C49858" font-family="sans-serif" font-size="13" textLength="234.768">returned from hasRemaining().  If the</text><text x="949" y="881.793" fill="#C49858" font-family="sans-serif" font-size="13" textLength="211.815">portal has both a pid and sid, call</text><text x="949" y="897.104" fill="#C49858" font-family="sans-serif" font-size="13" textLength="261.993">updateUsage() twice. The call with the sid</text><text x="949" y="912.414" fill="#C49858" font-family="sans-serif" font-size="13" textLength="237.637">usage should have a quantity of zero.</text><g class="message" data-participant-1="Bookkeeper" data-participant-2="Repository"><path fill="#333" d="m597.493 942.467-10 4 10 4-4-4z" style="stroke:#333;stroke-width:1"/><path d="M591.493 946.467h341.145" style="stroke:#333;stroke-width:1;stroke-dasharray:2,2"/><text x="603.493" y="941.725" fill="#999" font-family="sans-serif" font-size="13" textLength="16.44">15</text><text x="623.933" y="941.725" font-family="sans-serif" font-size="13" textLength="36.277">quota</text></g></svg>